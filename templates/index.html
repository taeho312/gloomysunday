{% extends "base.html" %}
{% block content %}
<style>
    .rumor-card.erased { opacity: 0.4 !important; filter: grayscale(1); }
</style>

<div class="write-section" style="max-width: 850px; margin: 40px auto 60px auto;">
    {% if current_user.is_authenticated %}
    <form id="post-form" action="{{ url_for('edit_post', post_id=edit_post.id) if edit_post else url_for('post') }}" method="POST">
        <div id="editor-wrapper" style="border: 1px solid rgba(224, 134, 31, 0.3); background: rgba(0,0,0,0.5);">
            <div id="editor-container" style="height: 220px;">{% if edit_post %}{{ edit_post.content|safe }}{% endif %}</div>
        </div>
        <input type="hidden" name="content" id="content">
        <div style="text-align: right; margin-top: 15px;">
            {% if edit_post %}<a href="/" style="color: #888; text-decoration: none; margin-right: 20px;">취소</a>{% endif %}
            <button type="submit" style="background: #fff; color: #000; border: none; padding: 10px 45px; font-weight: bold; cursor: pointer;">{{ '수정' if edit_post else '쪽지 붙이기' }}</button>
        </div>
    </form>
    {% endif %}
</div>

<div class="rumor-list" style="max-width: 850px; margin: 0 auto 100px auto;">
    {% for post in posts %}
    <div class="rumor-card {{ 'erased' if '삭제된 쪽지입니다' in post.content else '' }}" 
         style="background: rgba(10, 26, 18, 0.65); border: 1px solid rgba(224, 134, 31, 0.25); padding: 25px; margin-bottom: 25px; backdrop-filter: blur(8px);">
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(224,134,31,0.1); padding-bottom: 10px; margin-bottom: 15px;">
            <span style="color: #e0861f; font-weight: bold; font-size: 0.85rem;">
                {% if '삭제된 쪽지입니다' in post.content %}<span style="color: #444;">[삭제됨]</span>{% elif current_user.is_admin %}{{ post.author.username }}{% else %}익명의 기록자{% endif %}
                {% if post.is_edited and '삭제된 쪽지입니다' not in post.content %}<small style="color: #666; font-weight: normal; margin-left: 8px;">(수정됨)</small>{% endif %}
            </span>
            <span style="color: #666; font-size: 0.75rem;">{{ post.date_posted.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
        <div class="ql-editor" style="color: #efefef; line-height: 1.7;">{{ post.content|safe }}</div>
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
            {% if post.user_id == current_user.id and not post.is_edited and '삭제된 쪽지입니다' not in post.content and (now - post.date_posted).total_seconds() < 1800 %}
                <a href="{{ url_for('edit_post', post_id=post.id) }}" style="color: #aaa; text-decoration: none; font-size: 0.75rem; border: 1px solid #444; padding: 3px 12px;">수정</a>
            {% endif %}
            {% if current_user.is_admin and '삭제된 쪽지입니다' not in post.content %}
                <a href="{{ url_for('delete_post', post_id=post.id) }}" onclick="return confirm('이 쪽지를 삭제하시겠습니까?');" style="color: #ff5555; text-decoration: none; font-size: 0.75rem; border: 1px solid #ff5555; padding: 3px 12px;">삭제</a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // [해결] 13종 서체 리스트 등록
        var fonts = ['Nanum Gothic', 'Nanum Myeongjo', 'Gothic A1', 'Hahmlet', 'Song Myung', 'Hurricane', 'Meddon', 'Estonia', 'Rock Salt', 'Playwrite IN Guides', 'Coral Pixels', 'Ma Shan Zheng', 'Zhi Mang Xing'];
        // [해결] 10종 사이즈 리스트 등록
        var sizes = ['9pt', '10pt', '12pt', '14pt', '16pt', '20pt', '24pt', '32pt', '40pt', '48pt'];

        var Font = Quill.import('attributors/style/font');
        var Size = Quill.import('attributors/style/size');
        Font.whitelist = fonts;
        Size.whitelist = sizes;
        Quill.register(Font, true);
        Quill.register(Size, true);

        var quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'font': fonts }],
                    [{ 'size': sizes }], // [해결] image_4b9b05 사이즈 리스트 연동
                    ['bold', 'italic', 'underline'],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ]
            },
            placeholder: '입주민 게시판에 쪽지를 남길 수 있습니다.'
        });
        
        document.getElementById('post-form').onsubmit = function() {
            document.getElementById('content').value = quill.root.innerHTML;
        };
    });
</script>
{% endblock %}